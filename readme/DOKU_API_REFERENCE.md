# DOKU Payment Gateway API Reference

> **Note:** This document is a reference guide compiled from DOKU official documentation artifacts (`doku*` files). For specific implementation details regarding this project, please refer to [`DOKU.md`](DOKU.md).

## 1. Introduction

### Preparation for New Merchant

There some step need to be prepared if you want to integrate with DOKU Checkout Page:

#### User Registration

In this section, DOKU Dashboard sandbox environment is used to integration process to our Checkout page. Sandbox is use for testing purpose where you can explore our features without making any real payments. In DOKU, it is very easy to get Sandbox access and explore our products. You can create the account by following the steps [here](https://developers.doku.com/get-started-with-doku-api/user-registration).

#### Retrieving API Keys

Make sure you already have Client ID & Secret Key to continue this section. Please refer to this [section](https://developers.doku.com/get-started-with-doku-api/retrieve-payment-credential).

#### Integration Steps

Here is the overview of how to integrate with Checkout:

1. [Backend Integration to initiate payment](https://developers.doku.com/accept-payments/doku-checkout/integration-guide/backend-integration)
2. [Frontend Integration to display DOKU Checkout Page](https://developers.doku.com/accept-payments/doku-checkout/integration-guide/frontend-integration)
3. [Create payment simulation](https://developers.doku.com/accept-payments/doku-checkout/integration-guide/simulate-payment-and-notification)
4. [Acknowledge payment result](https://developers.doku.com/accept-payments/doku-checkout/integration-guide/simulate-payment-and-notification)

---

## 2. Backend Integration

### Initiate Payment

To obtain the `payment.url`, you will need to hit this API through your Backend.

### Endpoint

| Type | Value |
| :--- | :--- |
| HTTP Method | POST |
| API endpoint (sandbox) | `https://api-sandbox.doku.com/checkout/v1/payment` |
| API endpoint (production) | `https://api.doku.com/checkout/v1/payment` |

### Request Headers

Here is the sample of request header to obtain `payment.url`:

```
Client-Id: MCH-0001-10791114622547
Request-Id: fdb69f47-96da-499d-acec-7cdc318ab2fe
Request-Timestamp: 2020-08-11T08:45:42Z
Signature: HMACSHA256=1jap2tpgvWt83tG4J7IhEwUrwmMt71OaIk0oL0e6sPM=
```

#### Request Header Explanation

| Parameter | Description |
| :--- | :--- |
| **`Client-Id`** | Client ID retrieved from DOKU Back Office |
| **`Request-Id`** | Unique random string (max 128 characters) generated from merchant side to protect duplicate request |
| **`Request-Timestamp`** | Timestamp request on UTC time in ISO8601 UTC+0 format. (e.g., `2020-09-22T01:51:00Z` for 08:51:00 WIB) |
| **`Signature`** | Security parameter generated on merchant Backend. See [Signature Generation](#3-signature-generation). |

### Request Body

#### Basic Request Example

```json
{
    "order": {
        "amount": 20000,
        "invoice_number": "INV-20210231-0001"
    },
    "payment": {
        "payment_due_date": 60
    }
}
```

**Parameters:**

- `order.amount` (number, mandatory): In IDR Currency and without decimal. Max length: 12.
- `order.invoice_number` (string, mandatory): Generated by merchant. Max length: 64 (30 for Credit Card). No symbols allowed for KKI.
- `payment.payment_due_date` (number, optional): Payment due date in minutes. Default: 60.

This basic request supports: Virtual Account, Credit Card, QRIS, Convenience Store, E-money (OVO, Linkaja).

#### Full Request Example

```json
{
  "order": {
    "amount": 80000,
    "invoice_number": "INV-{{$timestamp}}",
    "currency": "IDR",
    "callback_url": "http://merchantcallbackurl.domain/",
    "auto_redirect": true,
    "line_items": [
      {
          "id": "001",
          "name": "Fresh flowers",
          "quantity": 1,
          "price": 40000
      }
    ]
  },
  "payment": {
      "payment_due_date": 60,
      "payment_method_types": ["VIRTUAL_ACCOUNT_BCA", "CREDIT_CARD", "QRIS"]
  },
  "customer": {
      "id": "JC-01",
      "name": "Zolanda",
      "email": "zolanda@example.com",
      "phone": "628121212121"
  }
}
```

### Response

**Success Response (HTTP 200)**

```json
{
    "message": ["SUCCESS"],
    "response": {
        "order": {
            "amount": "20000",
            "invoice_number": "INV-20210231-0001"
        },
        "payment": {
            "payment_due_date": 60,
            "token_id": "2ebffd22d23e436895ce5c38f7ddcf86...",
            "url": "https://sandbox.doku.com/checkout-link-v2/...",
            "expired_date": "20240712104711"
        }
    }
}
```

---

## 3. Signature Generation

### Components

The signature requires the following components:

| Name | Description |
| :--- | :--- |
| `Client-Id` | Retrieved from Request Header |
| `Request-Id` | Retrieved from Request Header |
| `Request-Timestamp` | Retrieved from Request/Response Header |
| `Request-Target` | The path of the endpoint (e.g., `/checkout/v1/payment`) |
| `Digest` | Encoded (base64) value of hashed (SHA-256) JSON body (Only for POST) |

### Steps to Generate Signature

1.  **Prepare the String to Sign:**
    Arrange the components separated by a newline (`\n`).

    ```
    Client-Id:MCH-0001-10791114622547
    Request-Id:cc682442-6c22-493e-8121-b9ef6b3fa728
    Request-Timestamp:2020-08-11T08:45:42Z
    Request-Target:/checkout/v1/payment
    Digest:5WIYK2TJg6iiZ0d5v4IXSR0EkYEkYOezJIma3Ufli5s=
    ```

2.  **Calculate HMAC-SHA256:**
    Calculate HMAC-SHA256 of the string using your **Secret Key**.

3.  **Encode to Base64:**
    Encode the result to Base64.

4.  **Format the Header:**
    Prepend `HMACSHA256=` to the signature.

    ```
    Signature: HMACSHA256=OvIRJs/jH8BIcGsktr4d8nnYtxY6E0Uzdm9d1GVgv5s=
    ```

---

## 4. Code Examples

### Node.js Implementation

Sample code to initiate payment using `@doku-id/jokul-nodejs-library`.

```javascript
const Doku = require('@doku-id/jokul-nodejs-library');

// 1. Setup Your Secret Keys
Doku.setup({
    clientId: 'CLIENT_ID_ANDA_DISINI',
    secretKey: 'SECRET_KEY_ANDA_DISINI',
    environment: 'sandbox' // Change to 'production' when live
});

// 2. Function to Create Payment Page
async function createDokuPage() {
    // Generate random invoice number to avoid 'Duplicate Order ID' error
    const invoiceNumber = "INV-" + Date.now();

    const requestBody = {
        order: {
            amount: 50000, // Rp 50.000
            invoice_number: invoiceNumber,
            callback_url: "http://localhost:3000/payment/finish", // Redirect Page (UI)
            auto_redirect: true
        },
        payment: {
            payment_due_date: 60 // Expired in 60 minutes
        },
        customer: {
            name: "User Testing",
            email: "test@example.com"
        }
    };

    try {
        // 3. Send Request to DOKU
        const response = await Doku.Payment.createCheckout(requestBody);

        // 4. Get Payment URL
        const paymentUrl = response.response.payment.url;

        console.log("---------------------------------------");
        console.log("SUCCESS! Please redirect user here:");
        console.log(paymentUrl);
        console.log("---------------------------------------");

        // In a real app (e.g., Express.js):
        // res.redirect(paymentUrl);

    } catch (error) {
        console.error("Failed to create payment page:", error);
    }
}

createDokuPage();
```
