<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß iCal & Booking Debug Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            padding: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .test-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }
        
        .test-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-primary { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .btn-danger { background: linear-gradient(135deg, #F44336, #D32F2F); }
        .btn-info { background: linear-gradient(135deg, #00BCD4, #0097A7); }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success { border-left-color: #4CAF50; background: #f1f8e9; }
        .error { border-left-color: #F44336; background: #ffebee; }
        .warning { border-left-color: #FF9800; background: #fff8e1; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #4CAF50; }
        .status-error { background: #F44336; }
        .status-warning { background: #FF9800; }
        .status-info { background: #2196F3; }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .url-display {
            background: #263238;
            color: #4CAF50;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .booking-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .booking-form .full-width {
            grid-column: 1 / -1;
        }
        
        .emoji {
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .booking-form {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">üîß</span> iCal & Booking Debug Suite</h1>
            <p>Comprehensive testing for calendar integration and booking functionality</p>
        </div>
        
        <div class="content">
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="btn btn-info" onclick="testAllAPIs()">üöÄ Test All APIs</button>
                <button class="btn btn-primary" onclick="clearAllResults()">üßπ Clear Results</button>
                <button class="btn btn-warning" onclick="generateTestData()">üìä Generate Test Data</button>
                <button class="btn" onclick="downloadDebugReport()">üìÑ Download Report</button>
            </div>
            
            <!-- iCal Testing Section -->
            <div class="section">
                <div class="section-header">
                    <span class="emoji">üìÖ</span> iCal Export & Subscription Testing
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4><span class="status-indicator status-info"></span>Calendar Export</h4>
                            <p>Test .ics file generation and download</p>
                            <button class="btn" onclick="testICalExport('all')">Export All</button>
                            <button class="btn btn-primary" onclick="testICalExport('confirmed')">Confirmed Only</button>
                            <button class="btn btn-warning" onclick="testICalExport('pending')">Pending Only</button>
                        </div>
                        
                        <div class="test-card">
                            <h4><span class="status-indicator status-success"></span>Subscription URLs</h4>
                            <p>Generate calendar subscription links</p>
                            <button class="btn btn-info" onclick="getSubscriptionUrls()">Get URLs</button>
                            <button class="btn" onclick="testWebcalUrl()">Test Webcal</button>
                        </div>
                        
                        <div class="test-card">
                            <h4><span class="status-indicator status-warning"></span>Calendar Data</h4>
                            <p>Test JSON calendar data endpoint</p>
                            <button class="btn" onclick="getCalendarJSON()">Get JSON Data</button>
                            <button class="btn btn-primary" onclick="validateCalendarFormat()">Validate Format</button>
                        </div>
                        
                        <div class="test-card">
                            <h4><span class="status-indicator status-success"></span>External Blocks</h4>
                            <p>Test external calendar blocks API</p>
                            <button class="btn btn-info" onclick="testExternalBlocks()">List Blocks</button>
                            <button class="btn" onclick="testExternalBlocksFiltered()">Test Filters</button>
                        </div>
                    </div>
                    <div id="ical-results" class="results" style="display: none;"></div>
                </div>
            </div>
            
            <!-- Booking Testing Section -->
            <div class="section">
                <div class="section-header">
                    <span class="emoji">üè®</span> Booking System Testing
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4><span class="status-indicator status-info"></span>Quick Booking Tests</h4>
                            <button class="btn" onclick="testBookingAPI()">Test Booking API</button>
                            <button class="btn btn-primary" onclick="createTestBooking()">Create Test Booking</button>
                            <button class="btn btn-warning" onclick="testBookingValidation()">Test Validation</button>
                        </div>
                        
                        <div class="test-card">
                            <h4><span class="status-indicator status-success"></span>Package Integration</h4>
                            <button class="btn" onclick="testPackageBooking()">Test Package Booking</button>
                            <button class="btn btn-info" onclick="validatePackageRoomMapping()">Validate Mapping</button>
                        </div>
                    </div>
                    
                    <!-- Custom Booking Form -->
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 20px; color: #333;">üéØ Custom Booking Test</h3>
                        <form class="booking-form" onsubmit="submitTestBooking(event)">
                            <div class="form-group">
                                <label>Room ID</label>
                                <select id="room_id" required>
                                    <option value="">Select Room</option>
                                    <option value="deluxe-suite">Deluxe Suite</option>
                                    <option value="standard-room">Standard Room</option>
                                    <option value="family-room">Family Room</option>
                                    <option value="master-suite">Master Suite</option>
                                    <option value="economy-room">Economy Room</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Package ID (Optional)</label>
                                <select id="package_id">
                                    <option value="">No Package</option>
                                    <option value="1">Romantic Getaway</option>
                                    <option value="2">Adventure Explorer</option>
                                    <option value="3">Wellness Retreat</option>
                                    <option value="4">Cultural Heritage</option>
                                    <option value="5">Family Fun</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="first_name" value="Test User" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" id="last_name" value="Debug">
                            </div>
                            
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" value="test@example.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="phone" value="+1234567890">
                            </div>
                            
                            <div class="form-group">
                                <label>Check-in Date</label>
                                <input type="date" id="check_in" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Check-out Date</label>
                                <input type="date" id="check_out" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Adults</label>
                                <input type="number" id="adults" value="2" min="1" max="10" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Children</label>
                                <input type="number" id="children" value="0" min="0" max="10">
                            </div>
                            
                            <div class="form-group">
                                <label>Total Price</label>
                                <input type="number" id="total_price" value="500" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group full-width">
                                <label>Special Requests</label>
                                <textarea id="special_requests" rows="3" placeholder="Any special requests..."></textarea>
                            </div>
                            
                            <div class="form-group full-width">
                                <button type="submit" class="btn" style="width: 100%;">üöÄ Create Test Booking</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="booking-results" class="results" style="display: none;"></div>
                </div>
            </div>
            
            <!-- System Status Section -->
            <div class="section">
                <div class="section-header">
                    <span class="emoji">‚ö°</span> System Status & Health Check
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4><span class="status-indicator status-info"></span>API Health</h4>
                            <button class="btn" onclick="checkAPIHealth()">Check All APIs</button>
                            <button class="btn btn-info" onclick="testDatabaseConnection()">Test Database</button>
                        </div>
                        
                        <div class="test-card">
                            <h4><span class="status-indicator status-success"></span>Email System</h4>
                            <button class="btn" onclick="testEmailService()">Test Email Service</button>
                            <button class="btn btn-warning" onclick="sendTestEmail()">Send Test Email</button>
                        </div>
                    </div>
                    <div id="system-results" class="results" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/fontend-bookingengine-100/frontend-booking-engine-1/api/';
        const EMAIL_SERVICE = '/fontend-bookingengine-100/frontend-booking-engine-1/email-service.php';
        
        // Utility Functions
        function showResults(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `results ${type}`;
            element.innerHTML = content;
        }
        
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        function getCurrentDateTime() {
            return new Date().toLocaleString();
        }
        
        function setDefaultDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dayAfter = new Date(today);
            dayAfter.setDate(dayAfter.getDate() + 3);
            
            document.getElementById('check_in').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('check_out').value = dayAfter.toISOString().split('T')[0];
        }
        
        // Initialize default dates
        window.onload = function() {
            setDefaultDates();
        };
        
        // iCal Testing Functions
        async function testICalExport(status = 'all') {
            try {
                const url = `${API_BASE}ical.php?action=calendar&format=ics&status=${status}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `villa-bookings-${status}.ics`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    showResults('ical-results', 
                        `‚úÖ [${getCurrentDateTime()}] iCal Export (${status}) successful!\\n` +
                        `üìÅ File downloaded: villa-bookings-${status}.ics\\n` +
                        `üìä Size: ${(blob.size / 1024).toFixed(2)} KB\\n` +
                        `üîó URL: ${url}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResults('ical-results', 
                    `‚ùå [${getCurrentDateTime()}] iCal Export failed:\\n${error.message}`, 'error');
            }
        }
        
        async function getSubscriptionUrls() {
            try {
                const response = await fetch(`${API_BASE}ical.php?action=subscribe`);
                const data = await response.json();
                
                if (data.success) {
                    showResults('ical-results', 
                        `‚úÖ [${getCurrentDateTime()}] Subscription URLs retrieved:\\n\\n` +
                        `üì± Standard URL:\\n${data.subscribe_url}\\n\\n` +
                        `üçé Webcal URL:\\n${data.webcal_url}\\n\\n` +
                        `üìã Instructions available for:\\n` +
                        Object.keys(data.instructions).join(', '), 'success');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                showResults('ical-results', 
                    `‚ùå [${getCurrentDateTime()}] Failed to get subscription URLs:\\n${error.message}`, 'error');
            }
        }
        
        async function getCalendarJSON() {
            try {
                const response = await fetch(`${API_BASE}ical.php?action=calendar&format=json`);
                const data = await response.json();
                
                showResults('ical-results', 
                    `‚úÖ [${getCurrentDateTime()}] Calendar JSON data:\\n` +
                    `üìä Success: ${data.success}\\n` +
                    `üìÖ Events count: ${data.count || 0}\\n\\n` +
                    `Raw data:\\n${formatJSON(data)}`, 'success');
            } catch (error) {
                showResults('ical-results', 
                    `‚ùå [${getCurrentDateTime()}] Failed to get calendar JSON:\\n${error.message}`, 'error');
            }
        }
        
        async function testExternalBlocks() {
            try {
                const response = await fetch(`${API_BASE}external_blocks.php`);
                const data = await response.json();
                
                showResults('ical-results', 
                    `‚úÖ [${getCurrentDateTime()}] External blocks data:\\n` +
                    `üìä Success: ${data.success}\\n` +
                    `üö´ Blocks count: ${data.count || 0}\\n\\n` +
                    `Raw data:\\n${formatJSON(data)}`, 'success');
            } catch (error) {
                showResults('ical-results', 
                    `‚ùå [${getCurrentDateTime()}] Failed to get external blocks:\\n${error.message}`, 'error');
            }
        }
        
        async function testExternalBlocksFiltered() {
            try {
                const from = '2025-01-01';
                const to = '2025-12-31';
                const response = await fetch(`${API_BASE}external_blocks.php?from=${from}&to=${to}&source=airbnb`);
                const data = await response.json();
                
                showResults('ical-results', 
                    `‚úÖ [${getCurrentDateTime()}] Filtered external blocks:\\n` +
                    `üìä Success: ${data.success}\\n` +
                    `üö´ Blocks count: ${data.count || 0}\\n` +
                    `üìÖ Date range: ${from} to ${to}\\n` +
                    `üè† Source: airbnb\\n\\n` +
                    `Raw data:\\n${formatJSON(data)}`, 'success');
            } catch (error) {
                showResults('ical-results', 
                    `‚ùå [${getCurrentDateTime()}] Failed to get filtered blocks:\\n${error.message}`, 'error');
            }
        }
        
        // Booking Testing Functions
        async function testBookingAPI() {
            try {
                const response = await fetch(`${API_BASE}bookings.php`);
                const data = await response.json();
                
                showResults('booking-results', 
                    `‚úÖ [${getCurrentDateTime()}] Booking API test:\\n` +
                    `üìä Success: ${data.success}\\n` +
                    `üè® Bookings count: ${data.data?.length || 0}\\n\\n` +
                    `Sample data:\\n${formatJSON(data.data?.slice(0, 2) || [])}`, 'success');
            } catch (error) {
                showResults('booking-results', 
                    `‚ùå [${getCurrentDateTime()}] Booking API test failed:\\n${error.message}`, 'error');
            }
        }
        
        async function createTestBooking() {
            const bookingData = {
                room_id: 'deluxe-suite',
                first_name: 'Test',
                last_name: 'User',
                email: 'test@debug.com',
                phone: '+1234567890',
                check_in: '2025-12-20',
                check_out: '2025-12-23',
                adults: 2,
                children: 0,
                guests: 2,
                total_price: 750.00,
                special_requests: 'Debug test booking',
                source: 'debug'
            };
            
            try {
                const response = await fetch(`${API_BASE}bookings.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResults('booking-results', 
                        `‚úÖ [${getCurrentDateTime()}] Test booking created successfully!\\n` +
                        `üÜî Booking ID: ${data.data.id}\\n` +
                        `üìù Reference: ${data.data.booking_reference}\\n` +
                        `üìß Email status: ${JSON.stringify(data.email_status)}\\n\\n` +
                        `Full response:\\n${formatJSON(data)}`, 'success');
                } else {
                    throw new Error(data.error || 'Booking creation failed');
                }
            } catch (error) {
                showResults('booking-results', 
                    `‚ùå [${getCurrentDateTime()}] Test booking failed:\\n${error.message}`, 'error');
            }
        }
        
        async function submitTestBooking(event) {
            event.preventDefault();
            
            const formData = {
                room_id: document.getElementById('room_id').value,
                package_id: document.getElementById('package_id').value || null,
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                check_in: document.getElementById('check_in').value,
                check_out: document.getElementById('check_out').value,
                adults: parseInt(document.getElementById('adults').value),
                children: parseInt(document.getElementById('children').value),
                guests: parseInt(document.getElementById('adults').value) + parseInt(document.getElementById('children').value),
                total_price: parseFloat(document.getElementById('total_price').value),
                special_requests: document.getElementById('special_requests').value,
                source: 'debug-form'
            };
            
            try {
                const response = await fetch(`${API_BASE}bookings.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResults('booking-results', 
                        `‚úÖ [${getCurrentDateTime()}] Custom booking created!\\n` +
                        `üÜî Booking ID: ${data.data.id}\\n` +
                        `üìù Reference: ${data.data.booking_reference}\\n` +
                        `üè® Room: ${formData.room_id}\\n` +
                        `üìÖ Dates: ${formData.check_in} to ${formData.check_out}\\n` +
                        `üë• Guests: ${formData.guests} (${formData.adults} adults, ${formData.children} children)\\n` +
                        `üí∞ Total: $${formData.total_price}\\n` +
                        `üìß Email status: ${JSON.stringify(data.email_status)}`, 'success');
                } else {
                    throw new Error(data.error || 'Booking creation failed');
                }
            } catch (error) {
                showResults('booking-results', 
                    `‚ùå [${getCurrentDateTime()}] Custom booking failed:\\n${error.message}`, 'error');
            }
        }
        
        // System Testing Functions
        async function checkAPIHealth() {
            const endpoints = [
                'rooms.php',
                'packages.php',
                'bookings.php',
                'villa.php',
                'ical.php',
                'external_blocks.php'
            ];
            
            let results = `üîç [${getCurrentDateTime()}] API Health Check:\\n\\n`;
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`);
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    results += `${status} ${endpoint}: HTTP ${response.status}\\n`;
                } catch (error) {
                    results += `‚ùå ${endpoint}: ${error.message}\\n`;
                }
            }
            
            showResults('system-results', results, 'info');
        }
        
        async function testEmailService() {
            try {
                const testData = {
                    action: 'test_booking'
                };
                
                const response = await fetch(EMAIL_SERVICE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                showResults('system-results', 
                    `‚úÖ [${getCurrentDateTime()}] Email service test:\\n` +
                    `üìß Guest email: ${data.guest_email?.success}\\n` +
                    `üìß Admin email: ${data.admin_email?.success}\\n` +
                    `üìù Test reference: ${data.test_data?.booking_reference}\\n\\n` +
                    `Full response:\\n${formatJSON(data)}`, 'success');
            } catch (error) {
                showResults('system-results', 
                    `‚ùå [${getCurrentDateTime()}] Email service test failed:\\n${error.message}`, 'error');
            }
        }
        
        // Utility Functions
        function testAllAPIs() {
            checkAPIHealth();
            setTimeout(() => testBookingAPI(), 1000);
            setTimeout(() => getCalendarJSON(), 2000);
            setTimeout(() => testExternalBlocks(), 3000);
            setTimeout(() => testEmailService(), 4000);
        }
        
        function clearAllResults() {
            document.getElementById('ical-results').style.display = 'none';
            document.getElementById('booking-results').style.display = 'none';
            document.getElementById('system-results').style.display = 'none';
        }
        
        function generateTestData() {
            // Generate random test data for booking form
            const names = ['John Doe', 'Jane Smith', 'Mike Johnson', 'Sarah Wilson', 'David Brown'];
            const randomName = names[Math.floor(Math.random() * names.length)].split(' ');
            
            document.getElementById('first_name').value = randomName[0];
            document.getElementById('last_name').value = randomName[1];
            document.getElementById('email').value = `${randomName[0].toLowerCase()}@test.com`;
            document.getElementById('adults').value = Math.floor(Math.random() * 4) + 1;
            document.getElementById('children').value = Math.floor(Math.random() * 3);
            document.getElementById('total_price').value = (Math.random() * 1000 + 200).toFixed(2);
            
            showResults('booking-results', 
                `üéØ [${getCurrentDateTime()}] Test data generated!\\n` +
                `Name: ${randomName.join(' ')}\\n` +
                `Email: ${document.getElementById('email').value}\\n` +
                `Guests: ${document.getElementById('adults').value} adults, ${document.getElementById('children').value} children\\n` +
                `Price: $${document.getElementById('total_price').value}`, 'info');
        }
        
        function downloadDebugReport() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const report = `Villa Booking Engine Debug Report
Generated: ${getCurrentDateTime()}
========================================

iCal Results:
${document.getElementById('ical-results').textContent || 'No iCal tests run'}

Booking Results:
${document.getElementById('booking-results').textContent || 'No booking tests run'}

System Results:
${document.getElementById('system-results').textContent || 'No system tests run'}

Configuration:
API Base: ${API_BASE}
Email Service: ${EMAIL_SERVICE}
`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-report-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>