<!DOCTYPE html>
<html>
<head>
    <title>Direct Booking Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; font-family: monospace; white-space: pre-wrap; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <h1>Direct Frontend â†’ MySQL Localhost Test</h1>
    <p>This test mimics exactly what the frontend booking code does.</p>
    
    <button onclick="runDirectTest()" style="padding: 10px 20px; font-size: 16px; background: #007acc; color: white; border: none; cursor: pointer;">
        Make Test Booking
    </button>
    
    <div id="logs"></div>

    <script>
    let logContainer;
    
    function log(message, type = 'info') {
        if (!logContainer) {
            logContainer = document.getElementById('logs');
        }
        
        const logDiv = document.createElement('div');
        logDiv.className = `log ${type}`;
        logDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
        logContainer.appendChild(logDiv);
        console.log(message);
        
        // Auto-scroll to latest log
        logDiv.scrollIntoView({ behavior: 'smooth' });
    }

    async function runDirectTest() {
        const logsDiv = document.getElementById('logs');
        logsDiv.innerHTML = ''; // Clear previous logs
        
        log('ğŸš€ === STARTING DIRECT BOOKING TEST ===');
        
        // Use exact same data structure as frontend
        const apiBookingData = {
            roomId: "master-suite", 
            from: "2025-12-25",
            to: "2025-12-27",
            guests: 2,
            user: {
                firstName: "Direct",
                lastName: "Frontend",
                email: "direct-frontend@example.com",
                phone: "1111111111"
            },
            total: 599.99
        };
        
        const apiUrl = 'http://localhost/fontend-bookingengine-100/frontend-booking-engine/api/bookings';
        
        try {
            log('ğŸŒ Frontend Origin: ' + window.location.origin);
            log('ğŸ¯ Target API URL: ' + apiUrl);
            log('ğŸ“¦ POST data: ' + JSON.stringify(apiBookingData, null, 2));
            
            log('ğŸ“¤ Making fetch request...');
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(apiBookingData)
            });
            
            log('ğŸ“¥ Response received!');
            log('ğŸ“Š Response status: ' + response.status + ' ' + response.statusText, response.ok ? 'success' : 'error');
            log('âœ… Response ok: ' + response.ok);
            log('ğŸ“‹ Response headers: ' + JSON.stringify([...response.headers.entries()], null, 2));
            
            let rawBody = '';
            try {
                rawBody = await response.text();
                log('ğŸ“ Raw response body: ' + rawBody);
            } catch (e) {
                log('âŒ Failed reading raw body: ' + e.message, 'error');
                throw new Error('Failed to read response body');
            }

            let parsed = null;
            try {
                parsed = rawBody ? JSON.parse(rawBody) : null;
                log('ğŸ” Parsed JSON: ' + JSON.stringify(parsed, null, 2));
            } catch (e) {
                log('âŒ JSON parse failed: ' + e.message, 'error');
                log('ğŸ“ Raw body that failed to parse: ' + rawBody, 'error');
                throw new Error('Invalid JSON response from API');
            }

            if (!response.ok) {
                log('âŒ HTTP error status: ' + response.status + ' ' + response.statusText, 'error');
                throw new Error('HTTP ' + response.status + ': ' + rawBody);
            }
            
            // Check structure exactly like frontend does
            log('ğŸ” === RESPONSE ANALYSIS ===');
            log('ğŸ” parsed exists: ' + !!parsed);
            log('ğŸ” parsed.success: ' + parsed?.success);
            log('ğŸ” parsed.data exists: ' + !!parsed?.data);
            log('ğŸ” parsed.data.success: ' + parsed?.data?.success);
            log('ğŸ” parsed.data.booking exists: ' + !!parsed?.data?.booking);
            log('ğŸ” parsed.data.booking.id: ' + parsed?.data?.booking?.id);
            log('ğŸ” parsed.data.booking.reference: ' + parsed?.data?.booking?.reference);
            
            const hasCorrectStructure = parsed && 
                                       parsed.success === true && 
                                       parsed.data && 
                                       parsed.data.success === true && 
                                       parsed.data.booking && 
                                       parsed.data.booking.id;
                                       
            log('âœ… Has correct structure: ' + hasCorrectStructure, hasCorrectStructure ? 'success' : 'error');
            
            if (!hasCorrectStructure) {
                log('âŒ FRONTEND WOULD GO OFFLINE - Unexpected response structure', 'error');
                log('Expected: { success: true, data: { success: true, booking: { id, reference } } }', 'warning');
                log('Received: ' + JSON.stringify(parsed, null, 2), 'warning');
                return;
            }
            
            // Success path
            const apiBookingResult = parsed.data.booking;
            const dbBookingId = apiBookingResult.id;
            const dbReference = apiBookingResult.reference;
            
            log('ğŸ‰ SUCCESS - FRONTEND WOULD SAVE TO DATABASE!', 'success');
            log('ğŸ“ Booking ID: ' + dbBookingId, 'success');
            log('ğŸ“ Booking Reference: ' + dbReference, 'success');
            log('âœ… Frontend would show: "Booking confirmed! Your booking reference is ' + dbReference + '"', 'success');
            
        } catch (error) {
            log('âŒ FRONTEND WOULD GO OFFLINE - Request failed: ' + error.message, 'error');
            log('ğŸ’¾ Frontend would save booking to localStorage for later sync', 'warning');
        }
    }
    </script>
</body>
</html>