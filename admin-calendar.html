<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Calendar Access</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="config.js"></script>
  <style>
    .day-cell { min-height: 60px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .badge-dot { width:6px; height:6px; border-radius:50%; display:inline-block; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="calendar-root" class="max-w-7xl mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Utility helpers
    const fmt = d => d.toISOString().slice(0,10);
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const range = (start, endExclusive) => { const out=[]; let cur=new Date(start); while(cur < endExclusive){ out.push(new Date(cur)); cur.setDate(cur.getDate()+1);} return out; };

    async function fetchJSON(endpoint){
      const res = await fetch(getApiUrl(endpoint));
      const data = await res.json();
      if(!data.success) throw new Error(data.error || 'API error');
      return data.data;
    }

    async function fetchUnified(from, to){
      const [bookings, external] = await Promise.all([
        fetchJSON('bookings.php'),
        fetchJSON('external_blocks.php') // external blocks endpoint
      ]);
      // Filter to range
      const within = (start, end) => !(end < from || start > to);
      const bookingItems = bookings.filter(b => within(b.check_in, b.check_out)).map(b => ({
        type:'booking',
        id:b.id,
        start:b.check_in,
        end:b.check_out,
        status:b.status,
        label:`#${b.id} ${b.first_name || ''}`.trim()
      }));
      const externalItems = external.filter(e => within(e.start_date, e.end_date)).map(e => ({
        type:'external',
        id:e.id || e.uid,
        start:e.start_date,
        end:e.end_date,
        source:e.source,
        label:e.summary || e.source
      }));
      return [...bookingItems, ...externalItems];
    }

    function buildDateMap(items){
      const map = {};
      items.forEach(it => {
        const start = new Date(it.start);
        const end = new Date(it.end); // treat end as exclusive
        for(let d=new Date(start); d < end; d.setDate(d.getDate()+1)){
          const key = fmt(d);
          (map[key] ||= []).push(it);
        }
      });
      return map;
    }

    function Legend(){
      return (
        <div className="flex gap-4 text-xs mb-4 flex-wrap">
          <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-green-500"></span>Booking</span>
          <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-red-500"></span>External Block</span>
          <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-purple-500"></span>Overlap</span>
          <span className="text-gray-500">(End date is exclusive)</span>
        </div>
      );
    }

    function MonthView({ month, dateMap, showBookings, showExternal }){
      const year = month.getFullYear();
      const mIndex = month.getMonth();
      const firstDay = new Date(year, mIndex, 1);
      const startWeekday = firstDay.getDay(); // 0 Sun
      const daysInMonth = new Date(year, mIndex+1, 0).getDate();
      const cells = [];
      for(let i=0;i<startWeekday;i++) cells.push(<div key={'pad-'+i} className="day-cell bg-gray-50 text-gray-300 text-xs p-1"></div>);
      for(let day=1; day <= daysInMonth; day++){
        const dateObj = new Date(year, mIndex, day);
        const key = fmt(dateObj);
        const items = dateMap[key] || [];
        const filtered = items.filter(it => (it.type==='booking' && showBookings) || (it.type==='external' && showExternal));
        const hasBooking = filtered.some(f=>f.type==='booking');
        const hasExternal = filtered.some(f=>f.type==='external');
        let bg = 'bg-white';
        if(hasBooking && hasExternal) bg='bg-purple-100';
        else if(hasBooking) bg='bg-green-100';
        else if(hasExternal) bg='bg-red-100';
        cells.push(<div key={key} className={`day-cell border rounded p-1 flex flex-col text-[11px] ${bg}`}>
          <div className="font-semibold text-xs">{day}</div>
          <div className="flex flex-wrap gap-[2px] mt-1">
            {filtered.slice(0,4).map((it,idx)=>(<span key={it.type+it.id+idx} className="px-1 py-[1px] rounded bg-white/70 border text-[10px] truncate" title={`${it.label} ${it.start}→${it.end}`}>{it.type==='booking'?'B':'X'}</span>))}
            {filtered.length>4 && <span className="text-[10px] text-gray-600">+{filtered.length-4}</span>}
          </div>
        </div>);
      }
      return (
        <div className="mb-8">
          <h3 className="text-sm font-medium mb-2">{month.toLocaleString('default',{month:'long'})} {year}</h3>
          <div className="grid grid-cols-7 text-[11px] font-medium mb-1">
            {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=> <div key={d} className="text-center">{d}</div>)}
          </div>
          <div className="cal-grid">{cells}</div>
        </div>
      );
    }

    function AdminCalendarPage(){
      const [items,setItems] = useState([]);
      const [loading,setLoading] = useState(false);
      const [error,setError] = useState(null);
      const [showBookings,setShowBookings] = useState(true);
      const [showExternal,setShowExternal] = useState(true);
      const [subscription,setSubscription] = useState(null);

      useEffect(()=>{ load(); loadSub(); },[]);

      async function load(){
        try{
          setLoading(true); setError(null);
          const from = fmt(new Date());
          const horizon = new Date(); horizon.setMonth(horizon.getMonth()+6);
          const to = fmt(horizon);
          const unified = await fetchUnified(from,to);
          setItems(unified);
        }catch(e){ setError(e.message); } finally { setLoading(false); }
      }

      async function loadSub(){
        try {
          const res = await fetch(getApiUrl('ical.php?action=subscribe'));
          const j = await res.json();
          if(j.success) setSubscription(j);
        } catch(e){ console.warn('Subscribe URL load failed', e); }
      }

      function exportIcs(status='all'){
        const url = getApiUrl(`ical.php?action=calendar&format=ics&status=${status}`);
        const link = document.createElement('a');
        link.href = url; link.download = `villa-bookings-${status}.ics`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
      }

      const dateMap = useMemo(()=> buildDateMap(items), [items]);
      const now = new Date();
      const months = [new Date(now.getFullYear(), now.getMonth(),1), new Date(now.getFullYear(), now.getMonth()+1,1), new Date(now.getFullYear(), now.getMonth()+2,1)];

      const upcoming = useMemo(()=>{
        const sorted = items.slice().sort((a,b)=> a.start.localeCompare(b.start));
        return sorted.slice(0,40);
      },[items]);

      return (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-bold">Calendar Access</h1>
            <div className="flex gap-2">
              <button onClick={load} disabled={loading} className="px-3 py-2 text-sm rounded bg-blue-600 text-white disabled:opacity-50">{loading?'Refreshing...':'Refresh'}</button>
            </div>
          </div>
          <Legend />
          {error && <div className="p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm">{error}</div>}

          <div className="flex flex-wrap gap-4 items-center text-sm">
            <label className="flex items-center gap-1"><input type="checkbox" checked={showBookings} onChange={e=>setShowBookings(e.target.checked)} />Bookings</label>
            <label className="flex items-center gap-1"><input type="checkbox" checked={showExternal} onChange={e=>setShowExternal(e.target.checked)} />External Blocks</label>
            <div className="ml-auto flex gap-2">
              <button onClick={()=>exportIcs('all')} className="px-2 py-1 bg-green-600 text-white rounded">Export All</button>
              <button onClick={()=>exportIcs('confirmed')} className="px-2 py-1 bg-indigo-600 text-white rounded">Export Confirmed</button>
              <button onClick={()=>exportIcs('pending')} className="px-2 py-1 bg-yellow-600 text-white rounded">Export Pending</button>
            </div>
          </div>

          {subscription && (
            <div className="bg-white p-4 rounded shadow space-y-2">
              <h2 className="text-lg font-semibold">Subscription URLs</h2>
              <div className="space-y-2 text-xs font-mono">
                <div><span className="font-semibold">Standard:</span> {subscription.subscribe_url}</div>
                <div><span className="font-semibold">WebCal:</span> {subscription.webcal_url}</div>
              </div>
              <p className="text-xs text-gray-600">Use in Google / Outlook / Apple Calendar for live sync.</p>
            </div>
          )}

          <div className="grid md:grid-cols-3 gap-6">
            {months.map(m => <MonthView key={m.toISOString()} month={m} dateMap={dateMap} showBookings={showBookings} showExternal={showExternal} />)}
          </div>

          <div className="bg-white rounded shadow p-4">
            <h2 className="text-lg font-semibold mb-2">Upcoming (next 40 items)</h2>
            <ul className="text-xs space-y-1 max-h-72 overflow-auto">
              {upcoming.map(it => (
                <li key={it.type+it.id} className="flex items-center gap-2">
                  <span className={`badge-dot ${it.type==='booking'?'bg-green-500':'bg-red-500'}`}></span>
                  <span className="font-mono">{it.start}→{it.end}</span>
                  <span className="truncate">{it.label}</span>
                  <span className="text-gray-500">{it.type==='booking'?it.status:it.source}</span>
                </li>
              ))}
              {upcoming.length===0 && !loading && <li className="text-gray-500">No items loaded.</li>}
              {loading && <li className="text-gray-500">Loading...</li>}
            </ul>
          </div>

          <div className="text-xs text-gray-500 pt-4 border-t">
            <p>Range end date is exclusive. External blocks imported via sync appear in red. Overlap days are purple.</p>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('calendar-root')).render(<AdminCalendarPage />);
  </script>
</body>
</html>